# Dynamic configuration
http:
  services:
    error-pages:
      loadBalancer:
        servers:
          - url: "http://localhost:5001"
          
  middlewares:
    serve-pretty-errors:
      errors:
        status:
          - "400-599"
        service: error-pages
        query: "/{status}.html"

    nofloc:
      headers:
        customResponseHeaders:
          Permissions-Policy: "interest-cohort=()"

    # Redirect to add trailing slash
    trailing-slash:
      redirectregex:
        regex: "^(https?://[^/]+/[a-z0-9_]+)$"
        replacement: "${1}/"
        permanent: true

    # Rate limiting - prevents spam/DOS
    rate-limit:
      rateLimit:
        average: 100 # requests per second
        burst: 50 # burst capacity
        period: 1s

    # Stricter rate limit for auth endpoints
    rate-limit-auth:
      rateLimit:
        average: 5
        burst: 10
        period: 1m

    # Very aggressive rate limiting for testing
    test-rate-limit:
      rateLimit:
        average: 5 # only 5 requests per second
        burst: 10 # only 10 burst capacity
        period: 1s

    # Security headers
    security-headers:
      headers:
        frameDeny: true
        browserXssFilter: true
        contentTypeNosniff: true
        sslRedirect: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000

    # Complete protection chain with errors
    default-chain:
      chain:
        middlewares:
          - serve-pretty-errors
          - rate-limit
          - security-headers

tls:
  # certificates:
  #   - certFile: "/etc/certs/local-cert.pem"
  #     keyFile: "/etc/certs/local-key.pem"
  #     stores:
  #       - default
  options:
    default:
      cipherSuites:
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
      minVersion: VersionTLS12
